# -------------------------------------------------
# Server 2016 Safe BitLocker Script
# Encrypts non-C: drives (used space only)
# Waits for each drive to finish before starting the next
# Supports deterministic unlock password, recovery key, dry-run, CSV logging
# -------------------------------------------------

$OSDrive = "C:"
$DelaySeconds = 30 * 60
$DesktopPath = [Environment]::GetFolderPath("Desktop")
$CsvPath = Join-Path $DesktopPath "BitLocker_Full_Encrypt_Log_$(Get-Date -Format 'yyyyMMdd_HHmmss').csv"

# Create CSV header
"Drive,RecoveryKey,DateTime,Status" | Out-File -FilePath $CsvPath -Encoding UTF8

function Write-CsvLog {
    param ($Drive, $RecoveryKey, $Status)
    $line = "$Drive,$RecoveryKey,$(Get-Date -Format 'yyyy-MM-dd HH:mm:ss'),$Status"
    Add-Content -Path $CsvPath -Value $line
    Write-Host $line
}

# Function to wait for encryption to complete
function Wait-EncryptionComplete {
    param($MountPoint)
    Write-Host "Waiting for $MountPoint to finish encryption..."
    do {
        $BL = Get-BitLockerVolume -MountPoint $MountPoint
        Write-Host "Encryption percentage: $($BL.EncryptionPercentage)%"
        Start-Sleep -Seconds 30
    } while ($BL.VolumeStatus -eq "EncryptionInProgress")
    Write-Host "$MountPoint encryption complete."
}

# Discover all fixed drives except OS
$Drives = Get-BitLockerVolume | Where-Object { $_.MountPoint -ne $OSDrive }

if (-not $Drives) {
    Write-Host "No eligible drives found. Exiting."
    exit
}

# -----------------------------
# Pre-run summary
# -----------------------------
Write-Host ""
Write-Host "PRE-RUN SUMMARY" -ForegroundColor Cyan
Write-Host "Excluded OS Drive: C:"
Write-Host "Delay between drives: 30 minutes"
Write-Host "Drives to be processed:"
$Drives | ForEach-Object { Write-Host " - $($_.MountPoint)" }
Write-Host ""

# -----------------------------
# Dry-run prompt
# -----------------------------
$DryRunChoice = Read-Host "Run in DRY RUN mode? (Y/N)"
$IsDryRun = $true
if ($DryRunChoice -match '^[Nn]$') {
    $IsDryRun = $false
    $Password = Read-Host -AsSecureString -Prompt "Enter BitLocker encryption password"
}

if ($IsDryRun) {
    Write-CsvLog "ALL" "N/A" "Dry run selected"
}

# -----------------------------
# Process each drive
# -----------------------------
foreach ($Drive in $Drives) {
    $MountPoint = $Drive.MountPoint
    Write-Host ""
    Write-Host "Processing $MountPoint..."

    if ($IsDryRun) {
        Write-CsvLog $MountPoint "N/A" "Dry run - no action taken"
        continue
    }

    try {
        # Suspend any ongoing BitLocker activity
        Suspend-BitLocker -MountPoint $MountPoint -RebootCount 0 -ErrorAction SilentlyContinue

        # Remove all existing protectors
        foreach ($KP in $Drive.KeyProtector) {
            Remove-BitLockerKeyProtector -MountPoint $MountPoint -KeyProtectorId $KP.KeyProtectorId -ErrorAction SilentlyContinue
        }
        Write-CsvLog $MountPoint "N/A" "Existing protectors removed"

        # Optional: decrypt partially encrypted drive
        $BL = Get-BitLockerVolume -MountPoint $MountPoint
        if ($BL.VolumeStatus -eq "EncryptionInProgress") {
            Write-Host "$MountPoint is partially encrypted. Decrypting first..."
            Disable-BitLocker -MountPoint $MountPoint
            do {
                Start-Sleep -Seconds 30
                $BL = Get-BitLockerVolume -MountPoint $MountPoint
            } while ($BL.VolumeStatus -eq "EncryptionInProgress")
            Write-Host "$MountPoint fully decrypted."
        }

        Start-Sleep -Seconds 5  # short pause

        # Add recovery key first (Server 2016-safe)
        $RecoveryProtector = Add-BitLockerKeyProtector -MountPoint $MountPoint -RecoveryPasswordProtector
        $RecoveryKey = $RecoveryProtector.RecoveryPassword
        Write-Host "Recovery key added: $RecoveryKey"

        # Enable BitLocker with password protector (used space only)
        Enable-BitLocker -MountPoint $MountPoint -PasswordProtector -Password $Password -UsedSpaceOnly
        Write-CsvLog $MountPoint $RecoveryKey "Encryption started"

        # Wait for encryption to finish before moving on
        Wait-EncryptionComplete -MountPoint $MountPoint

        Write-Host "Waiting 30 minutes before next drive..." -ForegroundColor Cyan
        Start-Sleep -Seconds $DelaySeconds

    } catch {
        Write-CsvLog $MountPoint "N/A" "ERROR: $_"
        throw
    }
}

# -----------------------------
# Add deterministic unlock password to all data drives
# Format: B1T + <SerialNumber> + L0K3r
# -----------------------------
$SerialNumber = (Get-WmiObject Win32_BIOS).SerialNumber.Trim()
$UnlockPasswordPlain = "B1T$SerialNumber" + "L0K3r"
$UnlockPassword = ConvertTo-SecureString $UnlockPasswordPlain -AsPlainText -Force

Write-Host ""
Write-Host "Adding deterministic unlock password to data drives..."
Write-Host "Password format: B1T<SERIAL>L0K3r"


Write-Host "CSV log saved to: $CsvPath"
