# DHCP Scope Creation Script with Gateway, Exclusions, and Option 43
# Logs all actions to desktop

# CSV paths
$csvPath = "$env:USERPROFILE\Desktop\dhcp_scopes.csv"
$logPath = "$env:USERPROFILE\Desktop\dhcp_scope_log.csv"

# Initialize log array
$log = @()

# Import CSV
$scopes = Import-Csv -Path $csvPath

foreach ($scope in $scopes) {
    try {
        $ScopeID    = $scope.ScopeID
        $Name       = $scope.Name
        $SubnetMask = $scope.SubnetMask
        $StartRange = $scope.StartRange
        $EndRange   = $scope.EndRange
        $Gateway    = $scope.Gateway
        $Exclusions = $scope.Exclusions -split ','  # Split multiple exclusions
        $Option43   = $scope.Option43

        # Create the DHCP scope
        Add-DhcpServerv4Scope `
            -Name $Name `
            -StartRange $StartRange `
            -EndRange $EndRange `
            -SubnetMask $SubnetMask `
            -LeaseDuration ([TimeSpan]::FromDays(14)) `
            -ErrorAction Stop

        # Set gateway
        Set-DhcpServerv4OptionValue `
            -ScopeId $ScopeID `
            -Router $Gateway `
            -ErrorAction Stop

        # Set Option 43 if provided
        if ($Option43 -and $Option43.Trim() -ne "") {
            Set-DhcpServerv4OptionValue `
                -ScopeId $ScopeID `
                -OptionId 43 `
                -Value $Option43 `
                -ErrorAction Stop
        }

        # Apply exclusions
        foreach ($excl in $Exclusions) {
            if ($excl -and $excl.Trim() -ne "") {
                # Support single IP by allowing Start=End
                if ($excl -notmatch '-') {
                    $excl = "$excl-$excl"
                }
                $exclStartEnd = $excl -split '-'
                Add-DhcpServerv4ExclusionRange `
                    -ScopeId $ScopeID `
                    -StartRange $exclStartEnd[0] `
                    -EndRange $exclStartEnd[1] `
                    -ErrorAction Stop
            }
        }

        # Log success
        $log += [PSCustomObject]@{
            ScopeID    = $ScopeID
            Name       = $Name
            Status     = "Created Successfully"
            Gateway    = $Gateway
            StartRange = $StartRange
            EndRange   = $EndRange
            Exclusions = $Exclusions -join ';'
            Option43   = $Option43
        }
    }
    catch {
        # Log failure
        $log += [PSCustomObject]@{
            ScopeID    = $ScopeID
            Name       = $Name
            Status     = "Error: $($_.Exception.Message)"
            Gateway    = $Gateway
            StartRange = $StartRange
            EndRange   = $EndRange
            Exclusions = $Exclusions -join ';'
            Option43   = $Option43
        }
    }
}

# Export log to CSV
$log | Export-Csv -Path $logPath -NoTypeInformation -Force
Write-Host "DHCP scope creation completed. Log exported to $logPath"
