Import-Module DhcpServer

# ===================== LEGEND =====================
# Exclusions are offsets from the StartIP (gateway):
# 0   = gateway only
# 0..4 = first 5 IPs (gateway through +4)
# @(0,5,10) = gateway plus specific IPs
# Edit ONLY the $ExcludeOffsets line below to change exclusions.
# =================================================

$ExcludeOffsets = @(0)   # EDIT HERE TO EXPAND EXCLUSIONS
$CsvPath = "C:\Temp\Scopes.csv"

# Desktop log path
$Desktop = [Environment]::GetFolderPath("Desktop")
$LogPath = Join-Path $Desktop "DHCP_Scope_Changes.csv"

# Initialize log file if missing
if (-not (Test-Path $LogPath)) {
    "Timestamp,ScopeName,StartIP,EndIP,SubnetMask,Description,Gateway,ExcludedIPs,Status" |
        Out-File $LogPath -Encoding UTF8
}

# Import CSV
$Scopes = Import-Csv $CsvPath

foreach ($Scope in $Scopes) {

    $ScopeName   = $Scope.ScopeName
    $StartIP     = $Scope.StartIP
    $EndIP       = $Scope.EndIP
    $SubnetMask  = $Scope.SubnetMask
    $Description = $Scope.Description
    $Gateway     = $StartIP

    Write-Host "Processing scope: $ScopeName" -ForegroundColor Cyan

    try {
        # Check if scope exists
        $ExistingScope = Get-DhcpServerv4Scope -ErrorAction SilentlyContinue |
                         Where-Object { $_.StartRange -eq $StartIP }

        if ($ExistingScope) {
            Write-Host "Scope exists â€“ skipping" -ForegroundColor Yellow

            $LogLine = "$(Get-Date -Format s),$ScopeName,$StartIP,$EndIP,$SubnetMask,$Description,$Gateway, ,Skipped"
            $LogLine | Out-File $LogPath -Append
            continue
        }

        # Create scope
        Add-DhcpServerv4Scope -Name $ScopeName -Description $Description -StartRange $StartIP -EndRange $EndIP -SubnetMask $SubnetMask -State Active

        # Build exclusions
        $ExcludedIPs = @()
        foreach ($Offset in $ExcludeOffsets) {
            $IPAddr = ([System.Net.IPAddress]::Parse($StartIP).Address + $Offset)
            $ExcludedIP = [System.Net.IPAddress]::new($IPAddr).ToString()
            $ExcludedIPs += $ExcludedIP

            # Apply exclusion
            Add-DhcpServerv4ExclusionRange -ScopeId $StartIP -StartRange $ExcludedIP -EndRange $ExcludedIP
        }

        # Set default gateway
        Set-DhcpServerv4OptionValue -ScopeId $StartIP -Router $Gateway

        Write-Host "Created scope with exclusions applied" -ForegroundColor Green

        # Log creation
        $ExcludedString = $ExcludedIPs -join " "
        $LogLine = "$(Get-Date -Format s),$ScopeName,$StartIP,$EndIP,$SubnetMask,$Description,$Gateway,$ExcludedString,Created"
        $LogLine | Out-File $LogPath -Append
    }
    catch {
        Write-Host "Failed to create scope: $ScopeName" -ForegroundColor Red
        $LogLine = "$(Get-Date -Format s),$ScopeName,$StartIP,$EndIP,$SubnetMask,$Description,$Gateway, ,Failed"
        $LogLine | Out-File $LogPath -Append
    }
}

Write-Host "All scopes processed. Log saved to Desktop." -ForegroundColor Magenta
