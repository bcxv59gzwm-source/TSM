# DHCP Scope Creation Script with Explicit Gateway from CSV
# Handles dynamic subnet ranges, exclusions, and logs all activity

# CSV paths
$csvPath = "$env:USERPROFILE\Desktop\dhcp_scopes.csv"
$logPath = "$env:USERPROFILE\Desktop\dhcp_scope_log.csv"

# Initialize log array
$log = @()

# Import CSV
$scopes = Import-Csv -Path $csvPath

# Function to calculate usable IP range based on subnet mask
function Get-IPRange {
    param (
        [string]$Network,
        [string]$SubnetMask
    )
    $ip = [System.Net.IPAddress]::Parse($Network)
    $mask = [System.Net.IPAddress]::Parse($SubnetMask).GetAddressBytes()
    $ipBytes = $ip.GetAddressBytes()

    $startBytes = [byte[]]($ipBytes.Clone())
    $endBytes = [byte[]]($ipBytes.Clone())

    for ($i = 0; $i -lt 4; $i++) {
        $startBytes[$i] = $startBytes[$i] -band $mask[$i]
        $endBytes[$i] = $endBytes[$i] -bor (-bnot $mask[$i])
    }

    # Skip network and broadcast addresses
    $startBytes[3] = [byte]($startBytes[3] + 1)
    $endBytes[3] = [byte]($endBytes[3] - 1)

    $startIP = [System.Net.IPAddress]::Parse(($startBytes -join "."))
    $endIP = [System.Net.IPAddress]::Parse(($endBytes -join "."))
    return @{Start=$startIP; End=$endIP}
}

foreach ($scope in $scopes) {
    try {
        $ScopeID    = $scope.ScopeID
        $Name       = $scope.Name
        $SubnetMask = $scope.SubnetMask
        $Gateway    = $scope.Gateway
        $Exclusions = $scope.Exclusions -split ','

        # Calculate IP range dynamically
        $range = Get-IPRange -Network $ScopeID -SubnetMask $SubnetMask
        $startIP = $range.Start
        $endIP = $range.End

        # Create the DHCP scope
        Add-DhcpServerv4Scope -Name $Name -StartRange $startIP -EndRange $endIP -SubnetMask $SubnetMask -LeaseDuration ([TimeSpan]::FromDays(14)) -ErrorAction Stop

        # Set the gateway from CSV
        Set-DhcpServerv4OptionValue -ScopeId $ScopeID -Router $Gateway -ErrorAction Stop

        # Apply exclusions from CSV
        foreach ($excl in $Exclusions) {
            if ($excl) {
                $exclStartEnd = $excl -split '-'
                Add-DhcpServerv4ExclusionRange -ScopeId $ScopeID -StartRange $exclStartEnd[0] -EndRange $exclStartEnd[1] -ErrorAction Stop
            }
        }

        # Log success
        $log += [PSCustomObject]@{
            ScopeID    = $ScopeID
            Name       = $Name
            Status     = "Created Successfully"
            Gateway    = $Gateway
            StartIP    = $startIP
            EndIP      = $endIP
            Exclusions = $Exclusions -join ';'
        }
    }
    catch {
        # Log error
        $log += [PSCustomObject]@{
            ScopeID    = $ScopeID
            Name       = $Name
            Status     = "Error: $($_.Exception.Message)"
            Gateway    = $Gateway
            StartIP    = ""
            EndIP      = ""
            Exclusions = $Exclusions -join ';'
        }
    }
}

# Export log to CSV
$log | Export-Csv -Path $logPath -NoTypeInformation -Force
Write-Host "DHCP scope creation completed. Log exported to $logPath"
