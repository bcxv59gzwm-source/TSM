# ====================================
# Fully Unattended BitLocker Encryption - D Drive Only (Server 2016 Compatible)
# ====================================

# ----------------------------
# Configuration
# ----------------------------
$DriveLetter = "D:"
$ProgressInterval = 5                   # seconds for live encryption progress
$DesktopPath = [Environment]::GetFolderPath("Desktop")
$CSVLogPath = Join-Path $DesktopPath "BitLocker_ActivityLog.csv"

# Create CSV log header if it doesn't exist
if (-not (Test-Path $CSVLogPath)) {
    "DriveLetter,VolumeLabel,SizeGB,DateTime,Status,RecoveryKey" | Out-File -FilePath $CSVLogPath -Encoding UTF8
}

# ----------------------------
# Get the volume info
# ----------------------------
$TargetVolume = Get-BitLockerVolume -MountPoint $DriveLetter
if (-not $TargetVolume) {
    Write-Host "Drive $DriveLetter not found or no BitLocker volume exists."
    exit
}

$VolumeLabel = if ($TargetVolume.VolumeLabel) { $TargetVolume.VolumeLabel } else { "N/A" }

# ----------------------------
# Enable BitLocker with Recovery Key (fully unattended)
# ----------------------------
try {
    Write-Host "$(Get-Date -Format 'yyyy-MM-dd HH:mm:ss') - Starting encryption for $DriveLetter ($VolumeLabel)..."

    Enable-BitLocker -MountPoint $DriveLetter -UsedSpaceOnly -EncryptionMethod XtsAes256

    # Live progress
    do {
        Start-Sleep -Seconds $ProgressInterval
        $CurrentVolume = Get-BitLockerVolume -MountPoint $DriveLetter
        $Percent = if ($CurrentVolume.PercentEncrypted) { $CurrentVolume.PercentEncrypted } else { 0 }
        Write-Host ("Drive ${DriveLetter}: $Percent% encrypted") -NoNewline
        Write-Host "`r" -NoNewline
    } while ($CurrentVolume.VolumeStatus -ne "FullyEncrypted")

    Write-Host "`nEncryption complete for $DriveLetter"

    # Enable auto-unlock for non-OS drives
    Enable-BitLockerAutoUnlock -MountPoint $DriveLetter

    # Retrieve recovery key
    $CurrentVolume = Get-BitLockerVolume -MountPoint $DriveLetter
    $RecoveryProtector = $CurrentVolume.KeyProtector | Where-Object { $_.KeyProtectorType -eq 'RecoveryPassword' }
    $RecoveryKey = $RecoveryProtector.RecoveryPassword

    # Save recovery key to Desktop
    $RecoveryFileName = "${DriveLetter} DriveBitLocker Recovery key ($RecoveryKey).txt"
    $RecoveryFilePath = Join-Path $DesktopPath $RecoveryFileName
    "BitLocker Recovery Key: $RecoveryKey" | Out-File -FilePath $RecoveryFilePath -Encoding UTF8
    Write-Host "Recovery key saved to: $RecoveryFilePath"

    # Log activity to CSV
    $LogEntry = "$DriveLetter,$VolumeLabel,$([math]::Round($TargetVolume.Capacity/1GB,2)),$(Get-Date -Format 'yyyy-MM-dd HH:mm:ss'),Completed,$RecoveryKey"
    Add-Content -Path $CSVLogPath -Value $LogEntry

} catch {
    Write-Host "$(Get-Date -Format 'yyyy-MM-dd HH:mm:ss') - ERROR: Failed to encrypt drive $DriveLetter. $_"
    $LogEntry = "$DriveLetter,$VolumeLabel,$([math]::Round($TargetVolume.Capacity/1GB,2)),$(Get-Date -Format 'yyyy-MM-dd HH:mm:ss'),Failed,NA"
    Add-Content -Path $CSVLogPath -Value $LogEntry
}

Write-Host "$(Get-Date -Format 'yyyy-MM-dd HH:mm:ss') - Script finished. Activity log: $CSVLogPath"
