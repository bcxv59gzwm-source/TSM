# ---------------------------------------------
# Script: Encrypt All Drives Except C: (Server 2016)
# Logs activity and recovery keys to Desktop
# Adds automation switch and 30-minute delay
# Fully non-interactive (no password prompts)
# ---------------------------------------------

param (
    [switch]$Auto  # Use -Auto for full automation, otherwise stops after first drive
)

# Set up log file and CSV on Desktop
$DesktopPath = [Environment]::GetFolderPath("Desktop")
$LogFile = Join-Path $DesktopPath "DriveEncryptionLog_$(Get-Date -Format 'yyyyMMdd_HHmmss').txt"
$CSVFile = Join-Path $DesktopPath "RecoveryKeys_$(Get-Date -Format 'yyyyMMdd_HHmmss').csv"

# Create CSV file with headers
"Drive,RecoveryKey,DateTime" | Out-File -FilePath $CSVFile -Encoding UTF8

# Function to log messages
function Write-Log {
    param ([string]$Message, [string]$Level = "INFO")
    $TimeStamp = Get-Date -Format "yyyy-MM-dd HH:mm:ss"
    $Line = "[$TimeStamp] [$Level] $Message"
    Write-Host $Line
    Add-Content -Path $LogFile -Value $Line
}

Write-Log "Starting encryption script..."

# Get all fixed drives except C: that are not fully encrypted
$drives = Get-BitLockerVolume | Where-Object { $_.MountPoint -ne "C:" -and $_.VolumeStatus -ne "FullyEncrypted" }

if ($drives.Count -eq 0) {
    Write-Log "No drives found for encryption."
    exit
}

foreach ($drive in $drives) {
    $mount = $drive.MountPoint
    Write-Log "Processing drive $mount..."

    try {
        # Add a recovery password protector (non-interactive)
        $Protector = Add-BitLockerKeyProtector -MountPoint $mount -RecoveryPasswordProtector

        # Extract recovery key for logging
        $RecoveryKey = $Protector.RecoveryPassword
        Write-Log "Recovery key for $mount: $RecoveryKey"

        # Save recovery key to CSV
        $csvLine = "$mount,$RecoveryKey,$(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')"
        Add-Content -Path $CSVFile -Value $csvLine

        # Enable BitLocker using the existing protector
        Enable-BitLocker -MountPoint $mount -EncryptionMethod XtsAes256 -UsedSpaceOnly -KeyProtectorId $Protector.KeyProtectorId -Verbose
        Write-Log "Encryption started on $mount"
    }
    catch {
        Write-Log "ERROR encrypting $mount: $_" "ERROR"
    }

    # Automation switch
    if ($Auto) {
        Write-Log "Automation enabled. Waiting 30 minutes before next drive..."
        Start-Sleep -Seconds (30 * 60)  # 30-minute delay
    } else {
        Write-Log "Automation not enabled. Stopping after first drive."
        break
    }
}

Write-Log "All eligible drives processed."
Write-Log "Recovery keys saved to $CSVFile"
Write-Log "Script completed."
