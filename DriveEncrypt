# ---------------------------------------------
# Encrypt D: drive and log activity & recovery key to CSV
# Works on Server 2016 in PowerShell ISE
# ---------------------------------------------

# Must be run as Administrator
$DesktopPath = [Environment]::GetFolderPath("Desktop")
$CSVFile = Join-Path $DesktopPath "D_Drive_EncryptionLog_$(Get-Date -Format 'yyyyMMdd_HHmmss').csv"

# Create CSV file with headers
"Drive,RecoveryKey,DateTime,Status" | Out-File -FilePath $CSVFile -Encoding UTF8

# Function to log activity to CSV
function Log-Activity {
    param (
        [string]$Drive,
        [string]$RecoveryKey,
        [string]$Status
    )
    $line = "$Drive,$RecoveryKey,$(Get-Date -Format 'yyyy-MM-dd HH:mm:ss'),$Status"
    Add-Content -Path $CSVFile -Value $line
    Write-Host $line
}

try {
    # Step 1: Add a recovery key (random)
    $Protector = Add-BitLockerKeyProtector -MountPoint "D:" -RecoveryPasswordProtector
    $RecoveryKey = $Protector.RecoveryPassword

    # Step 2: Enable encryption (non-interactive)
    Enable-BitLocker -MountPoint "D:" -EncryptionMethod XtsAes256 -UsedSpaceOnly

    # Log success
    Log-Activity -Drive "D:" -RecoveryKey $RecoveryKey -Status "Encryption Started"
}
catch {
    # Log error
    Log-Activity -Drive "D:" -RecoveryKey "N/A" -Status "ERROR: $_"
}
