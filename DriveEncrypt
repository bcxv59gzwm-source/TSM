# Must be run as Administrator
$DesktopPath = [Environment]::GetFolderPath("Desktop")
$CSVFile = Join-Path $DesktopPath "D_Drive_EncryptionLog_$(Get-Date -Format 'yyyyMMdd_HHmmss').csv"

# Create CSV headers
"Drive,RecoveryKey,DateTime,Status" | Out-File -FilePath $CSVFile -Encoding UTF8

function Log-Activity {
    param (
        [string]$Drive,
        [string]$RecoveryKey,
        [string]$Status
    )
    $line = "$Drive,$RecoveryKey,$(Get-Date -Format 'yyyy-MM-dd HH:mm:ss'),$Status"
    Add-Content -Path $CSVFile -Value $line
    Write-Host $line
}

try {
    # Step 1: Add a recovery key
    $Protector = Add-BitLockerKeyProtector -MountPoint "D:" -RecoveryPasswordProtector
    $RecoveryKey = $Protector.RecoveryPassword
    Log-Activity -Drive "D:" -RecoveryKey $RecoveryKey -Status "Recovery key added"

    # Step 2: Enable BitLocker (simplest form)
    Enable-BitLocker -MountPoint "D:"

    # Step 3: Optional - set encryption method after enabling
    # (Server 2016 uses AES128 by default, can leave as is)
    Log-Activity -Drive "D:" -RecoveryKey $RecoveryKey -Status "Encryption started"
}
catch {
    Log-Activity -Drive "D:" -RecoveryKey "N/A" -Status "ERROR: $_"
}
