# -------------------------------------------------
# BitLocker Encryption Script (Server 2016 Safe)
# Handles existing password protectors
# Supports dry-run, logging, pre-run summary, 30-min delay
# -------------------------------------------------

$OSDrive = "C:"
$DelaySeconds = 30 * 60  # 30 minutes
$DesktopPath = [Environment]::GetFolderPath("Desktop")
$CsvPath = Join-Path $DesktopPath "BitLocker_Encryption_Log_$(Get-Date -Format 'yyyyMMdd_HHmmss').csv"

# Create CSV header
"Drive,RecoveryKey,DateTime,Status" | Out-File -FilePath $CsvPath -Encoding UTF8

function Write-CsvLog {
    param ($Drive, $RecoveryKey, $Status)
    $line = "$Drive,$RecoveryKey,$(Get-Date -Format 'yyyy-MM-dd HH:mm:ss'),$Status"
    Add-Content -Path $CsvPath -Value $line
    Write-Host $line
}

# Discover all fixed drives except C:
$Drives = Get-BitLockerVolume | Where-Object { $_.MountPoint -ne $OSDrive }

if (-not $Drives) {
    Write-Host "No eligible drives found. Exiting."
    exit
}

# -----------------------------
# Pre-run summary
# -----------------------------
Write-Host ""
Write-Host "PRE-RUN SUMMARY" -ForegroundColor Cyan
Write-Host "OS Drive (excluded): C:"
Write-Host "Delay between drives: 30 minutes"
Write-Host "Drives to be processed:"
$Drives | ForEach-Object { Write-Host " - $($_.MountPoint)" }
Write-Host ""

# -----------------------------
# Dry-run prompt
# -----------------------------
$DryRunChoice = Read-Host "Run in DRY RUN mode? (Y/N)"
$IsDryRun = $true
if ($DryRunChoice -match '^[Nn]$') {
    $IsDryRun = $false
    $Password = Read-Host -AsSecureString -Prompt "Enter BitLocker encryption password"
}

if ($IsDryRun) {
    Write-CsvLog "ALL" "N/A" "Dry run selected"
}

# -----------------------------
# Process each drive
# -----------------------------
foreach ($Drive in $Drives) {
    $MountPoint = $Drive.MountPoint

    # Skip fully encrypted drives
    if ($Drive.VolumeStatus -eq "FullyEncrypted") {
        Write-CsvLog $MountPoint "N/A" "Skipped - already encrypted"
        continue
    }

    Write-Host ""
    Write-Host "Processing drive $MountPoint..."

    if ($IsDryRun) {
        Write-CsvLog $MountPoint "N/A" "Dry run - no action taken"
        continue
    }

    try {
        # Check for existing password protector
        $ExistingPassword = $Drive.KeyProtector | Where-Object { $_.KeyProtectorType -eq "Password" }

        if (-not $ExistingPassword) {
            # Add shared password protector if none exists
            Add-BitLockerKeyProtector -MountPoint $MountPoint -PasswordProtector -Password $Password | Out-Null
            Write-Host "Added new password protector for $MountPoint"
        } else {
            Write-Host "Existing password protector found for $MountPoint - reusing it"
        }

        # Always add a new recovery key
        $RecoveryProtector = Add-BitLockerKeyProtector -MountPoint $MountPoint -RecoveryPasswordProtector
        $RecoveryKey = $RecoveryProtector.RecoveryPassword

        # Enable BitLocker using existing or new password protector
        Enable-BitLocker -MountPoint $MountPoint -PasswordProtector -Password $Password

        Write-CsvLog $MountPoint $RecoveryKey "Encryption started"

        Write-Host "Waiting 30 minutes before next drive..." -ForegroundColor Cyan
        Start-Sleep -Seconds $DelaySeconds
    }
    catch {
        Write-CsvLog $MountPoint "N/A" "ERROR: $_"
        throw  # Stop on first error
    }
}

Write-Host ""
Write-Host "Encryption process completed."
Write-Host "CSV log saved to: $CsvPath"
